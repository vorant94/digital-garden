---
import { getCollection } from 'astro:content';
import MainLayout from '@/layouts/MainLayout/MainLayout.astro';
import { Divider } from '@/components/Divider.tsx';
import { Headline } from '@/components/Headline.tsx';
import { ArchiveList } from '@/components/ArchiveList/ArchiveList.tsx';
import { ArchiveListItem } from '@/components/ArchiveList/ArchiveListItem.tsx';
import {
  sortEntriesByPublishedAt,
  PublishedAtFormat,
} from '@/shared/collection.helpers.ts';
import { getUniqPostTags } from '@/shared/post.helpers.ts';
import type { Post } from '@/shared/post.helpers.ts';
import { formatEntryPublishedAt } from '@/shared/collection.helpers';
import { getPostFullPath } from '@/shared/post.helpers';

export async function getStaticPaths() {
  const entries = sortEntriesByPublishedAt(await getCollection('posts'));
  const tags = getUniqPostTags(entries);

  return await Promise.all(
    tags.map(async (tag) => {
      const posts = entries.filter(({ data }) => data.tags.includes(tag));

      return {
        params: { tag },
        props: { posts, tag },
      };
    }),
  );
}

interface Props {
  tag: string;
  posts: Post[];
}

const { posts, tag } = Astro.props;
---

<MainLayout title={`${tag} posts`}>
  <Divider isLeft={false}>
    <Headline>#{tag}</Headline>
  </Divider>
  <ArchiveList>
    {
      posts.map((post) => (
        <ArchiveListItem
          left={post.data.title}
          right={formatEntryPublishedAt(
            post.data.publishedAt,
            PublishedAtFormat.SHORT,
          )}
          href={getPostFullPath(post)}
        />
      ))
    }
  </ArchiveList>
</MainLayout>
