---
import { getCollection } from 'astro:content';
import { partition } from 'lodash-es';
import { MainLayout } from '@/layouts/MainLayout';
import { Intro } from '@/components/Intro';
import { PostTiledList } from '@/components/PostTiledList';
import { PinnedPosts } from '@/components/PinnedPosts';
import { Link } from '@/components/Link';
import { Carousel } from '@/components/Carousel';
import { Divider } from '@/components/Divider';
import { Headline } from '@/components/Headline';
import { sortPostsByPublishedAt } from '@/shared/post.helpers';
import {
  getProjectFullPath,
  projectStatusToLabel,
  projectStatusToBadgeColor,
} from '@/shared/project.helpers';
import { isProjectDataWithCover } from '../shared/project.helpers';

const allPosts = sortPostsByPublishedAt(await getCollection('posts'));
const [pinnedPosts, allNonPinnedPosts] = partition(
  allPosts,
  (entry) => entry.data.isPinned,
);

const recentNonPunnedPosts = allNonPinnedPosts.slice(0, 3);

const projects = await getCollection('projects');
---

<MainLayout>
  <PinnedPosts posts={pinnedPosts} />

  <Intro />

  <Divider>
    <Headline>My Projects</Headline>
  </Divider>

  <Carousel>
    {
      projects.map((project) => {
        const { data } = project;

        return isProjectDataWithCover(data) ? (
          <Carousel.LinkSlide
            bgImageSrc={data.coverImage?.src}
            bgImageSrcDark={data.coverImageDark?.src}
            href={getProjectFullPath(project)}
            badgeLabel={projectStatusToLabel[data.status]}
            badgeColor={projectStatusToBadgeColor[data.status]}
            title={data.name}
            subTitle={data.slogan}
          />
        ) : (
          <Carousel.LinkSlide
            href={getProjectFullPath(project)}
            badgeLabel={projectStatusToLabel[data.status]}
            badgeColor={projectStatusToBadgeColor[data.status]}
            title={data.name}
            subTitle={data.slogan}
          />
        );
      })
    }
    <Carousel.EmptyLinkSlide href="/projects">See all</Carousel.EmptyLinkSlide>
  </Carousel>

  <Divider>
    <Headline>Recent Posts</Headline>
  </Divider>

  <PostTiledList>
    {recentNonPunnedPosts.map((post) => <PostTiledList.Item post={post} />)}
  </PostTiledList>

  <Link
    className="self-center"
    href="posts">
    See all
  </Link>
</MainLayout>
